# Kubernetes Port Forward Helper

Kubernetes 클러스터의 여러 컨텍스트에서 Pod 포트포워딩을 시각적으로 관리할 수 있는 데스크톱 애플리케이션입니다. 도메인 기반 접근 방식을 통해 복잡한 포트 번호를 기억할 필요 없이 간단한 도메인으로 서비스에 접근할 수 있습니다.

## 개요

이 애플리케이션은 여러 Kubernetes 클러스터 컨텍스트를 한 화면에서 관리하고, 각 Pod의 포트포워딩을 도메인 기반으로 자동 설정합니다. 포트포워딩을 활성화하면 `deployment.namespace.context` 형식의 도메인이 자동으로 생성되며, 프록시 서버를 통해 해당 도메인으로 서비스에 접근할 수 있습니다.

주요 기능:
- 여러 Kubernetes 클러스터 컨텍스트 관리
- 도메인 기반 접근 (포트 번호 불필요)
- 자동 프록시 서버 관리
- hosts 파일 자동 관리
- Kubernetes Client API 통합

## 사용법

### 설치

```bash
git clone <repository-url>
cd port-forward-helper
npm install
```

### 환경 설정

프로젝트 루트에 `.env` 파일을 생성합니다:

```bash
# Hosts 파일 수정을 위한 sudo 비밀번호 (선택사항)
# 설정하지 않으면 hosts 파일 수정 시 비밀번호를 입력하라는 프롬프트가 표시됩니다.
SUDO_PASSWORD=your_password

# 네임스페이스별 기본 포트 설정 (선택사항)
# 형식: 네임스페이스명 (쉼표로 구분)
VITE_ALLOWED_NAMESPACES=ov,platform
```

### 실행

개발 모드:
```bash
npm run dev
```

프로덕션 빌드:
```bash
npm run build
npm run preview
```

### 기본 사용 흐름

1. **컨텍스트 선택**: 상단 탭에서 Kubernetes 클러스터 선택
2. **네임스페이스 선택**: 왼쪽 사이드바에서 네임스페이스 선택
3. **포트포워딩 활성화**: Pod 목록에서 원하는 포트의 토글 스위치 활성화
4. **도메인 확인**: 활성화된 포트포워딩에 표시된 도메인 확인 (예: `track-management-api.ov.tx-aks-prod`)
5. **접근**: 브라우저나 API 클라이언트에서 `http://도메인` 형식으로 접근

### 도메인 복사

Active Port Forward 섹션에서 도메인 옆의 복사 버튼을 클릭하면 전체 도메인(컨텍스트 포함)이 클립보드에 복사됩니다. 복사된 도메인은 `http://도메인` 형식으로 바로 사용할 수 있습니다.

## 상세 구현 설명

### 도메인 기반 접근

포트포워딩을 활성화하면 자동으로 `deployment.namespace.context` 형식의 도메인이 생성됩니다. 이 도메인은 프록시 서버의 라우팅 테이블에 등록되며, hosts 파일에도 자동으로 추가됩니다.

**도메인 형식:**
- 전체 도메인: `track-management-api.ov.tx-aks-prod` (프록시 서버 라우팅용)
- 표시 도메인: `track-management-api.ov` (UI 표시용, 컨텍스트 제외)

**도메인 생성 규칙:**
- Deployment 이름이 있으면 Deployment 이름 사용
- 없으면 Pod 이름 사용
- 네임스페이스와 컨텍스트를 포함하여 중복 방지

### 프록시 서버

Express 기반 리버스 프록시 서버가 포트 80(또는 8080)에서 실행됩니다. 활성 포트포워딩이 있을 때만 자동으로 시작되며, 모든 포트포워딩이 비활성화되면 자동으로 종료됩니다.

**동작 방식:**
1. 첫 번째 포트포워딩 활성화 시 프록시 서버 시작
2. 도메인을 Host 헤더로 받아 해당 로컬 포트로 라우팅
3. 마지막 포트포워딩 비활성화 시 프록시 서버 종료

**포트 선택:**
- 기본적으로 포트 80 시도
- 포트 80이 사용 중이거나 권한이 없으면 8080으로 자동 fallback

### Kubernetes Client 통합

kubectl CLI 명령어 대신 `@kubernetes/client-node` 패키지를 사용하여 Kubernetes API와 직접 통신합니다. 이를 통해 더 안정적이고 프로그래밍 가능한 방식으로 포트포워딩을 관리할 수 있습니다.

**주요 변경사항:**
- 컨텍스트, 네임스페이스, Pod 목록 조회를 Kubernetes Client API로 처리
- 포트포워딩을 `PortForward` 클래스와 `net.Server`를 사용하여 구현
- 자동 포트 할당 (`portfinder` 사용)

### Hosts 파일 관리

애플리케이션이 hosts 파일을 자동으로 관리합니다. `PORT_FORWARD_HELPER_START`와 `PORT_FORWARD_HELPER_END` 마커 사이에 도메인 목록이 저장되며, 애플리케이션 종료 시 자동으로 정리됩니다.

**동작 방식:**
1. 포트포워딩 활성화 시 마커 섹션에 도메인 추가
2. 포트포워딩 비활성화 시 해당 도메인 제거
3. 애플리케이션 종료 시 마커 섹션 전체 제거

**비밀번호 설정:**
- `.env` 파일에 `SUDO_PASSWORD` 설정 시 자동으로 사용
- 설정하지 않으면 sudo 명령어 실행 시 비밀번호 프롬프트 표시

### UI 구성

**상단 헤더:**
- 애플리케이션 제목
- 컨텍스트 탭 (여러 클러스터 전환)
- 새로고침 버튼

**왼쪽 사이드바:**
- 네임스페이스 필터 목록
- 네임스페이스별 Pod 개수 표시
- 네임스페이스 선택/해제 기능

**메인 영역:**
- Pod 목록 및 포트 정보
- 포트포워딩 활성화/비활성화 토글
- 도메인 표시 (활성화된 경우)

**오른쪽 사이드바:**
- 활성 포트포워딩 목록
- 도메인 및 복사 버튼
- 전체 비활성화 기능

### 포트포워딩 프로세스 관리

각 포트포워딩은 `net.Server` 인스턴스로 관리됩니다. Kubernetes Client의 `PortForward` 클래스를 사용하여 Pod와의 연결을 유지하며, 로컬 포트는 `portfinder`를 통해 자동으로 할당됩니다.

**프로세스 추적:**
- 로컬 포트를 키로 사용하여 서버 인스턴스 추적
- 포트포워딩 비활성화 시 해당 서버 인스턴스 종료
- 애플리케이션 종료 시 모든 서버 인스턴스 정리

### 에러 처리

**권한 오류:**
- hosts 파일 읽기/쓰기 권한이 없을 때 sudo로 재시도
- `.env` 파일의 `SUDO_PASSWORD` 사용 또는 프롬프트 표시

**포트 충돌:**
- 기본 포트가 사용 중이면 자동으로 사용 가능한 포트 찾기
- 최대 65535까지 시도

**네트워크 오류:**
- Kubernetes API 연결 실패 시 에러 메시지 표시
- 포트포워딩 실패 시 상태 롤백

## 시스템 요구사항

- Node.js 18.0.0 이상
- Kubernetes 클러스터 접근 권한
- kubectl 설정 파일 (`~/.kube/config`)
- macOS/Linux: hosts 파일 수정을 위한 sudo 권한

## 문제 해결

### 프록시 서버가 시작되지 않음

포트 80이 이미 사용 중이거나 권한이 없을 수 있습니다. 포트 8080으로 자동 fallback되며, 개발자 콘솔에서 실제 사용 중인 포트를 확인할 수 있습니다.

### Hosts 파일이 수정되지 않음

`.env` 파일에 `SUDO_PASSWORD`를 설정했는지 확인하세요. 설정하지 않으면 sudo 명령어 실행 시 비밀번호를 입력해야 합니다.

### 도메인으로 접근이 안 됨

1. 프록시 서버가 실행 중인지 확인 (포트 80 또는 8080)
2. hosts 파일에 도메인이 등록되어 있는지 확인
3. 브라우저 캐시를 지우고 다시 시도

### 포트포워딩이 작동하지 않음

1. Pod가 실행 중인지 확인: `kubectl get pods -n <namespace>`
2. Kubernetes 클러스터 연결 상태 확인
3. 개발자 콘솔에서 에러 메시지 확인

## 기술 스택

- **Electron**: 데스크톱 애플리케이션 프레임워크
- **React**: UI 라이브러리
- **TypeScript**: 타입 안정성
- **Vite**: 빌드 도구
- **Express**: 프록시 서버
- **@kubernetes/client-node**: Kubernetes API 클라이언트
- **portfinder**: 자동 포트 할당
- **hostile**: hosts 파일 관리
- **dotenv**: 환경변수 관리

## 라이선스

MIT
